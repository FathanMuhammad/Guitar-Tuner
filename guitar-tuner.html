<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acoustic Guitar Tuner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide icons as inline SVG components
        const Music = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        );

        const Mic = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        );

        const MicOff = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01" />
            </svg>
        );

        const GuitarTuner = () => {
          const [isListening, setIsListening] = useState(false);
          const [frequency, setFrequency] = useState(0);
          const [note, setNote] = useState('');
          const [cents, setCents] = useState(0);
          const [closestString, setClosestString] = useState('');
          const [error, setError] = useState('');
          const [permissionStatus, setPermissionStatus] = useState('prompt');
          
          const audioContextRef = useRef(null);
          const analyserRef = useRef(null);
          const microphoneRef = useRef(null);
          const rafIdRef = useRef(null);
          const streamRef = useRef(null);

          const guitarStrings = [
            { name: 'E', frequency: 82.41, string: '6th (Low E)' },
            { name: 'A', frequency: 110.00, string: '5th (A)' },
            { name: 'D', frequency: 146.83, string: '4th (D)' },
            { name: 'G', frequency: 196.00, string: '3rd (G)' },
            { name: 'B', frequency: 246.94, string: '2nd (B)' },
            { name: 'E', frequency: 329.63, string: '1st (High E)' }
          ];

          const noteStrings = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

          const frequencyToNote = (freq) => {
            const noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
            const roundedNoteNum = Math.round(noteNum) + 69;
            const noteName = noteStrings[roundedNoteNum % 12];
            return noteName;
          };

          const getCents = (freq, targetFreq) => {
            return Math.floor(1200 * Math.log(freq / targetFreq) / Math.log(2));
          };

          const findClosestString = (freq) => {
            let closest = guitarStrings[0];
            let minDiff = Math.abs(freq - closest.frequency);
            
            for (let string of guitarStrings) {
              const diff = Math.abs(freq - string.frequency);
              if (diff < minDiff) {
                minDiff = diff;
                closest = string;
              }
            }
            
            return closest;
          };

          const autoCorrelate = (buffer, sampleRate) => {
            let size = buffer.length;
            let maxSamples = Math.floor(size / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;

            for (let i = 0; i < size; i++) {
              rms += buffer[i] * buffer[i];
            }
            rms = Math.sqrt(rms / size);
            
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            for (let offset = 1; offset < maxSamples; offset++) {
              let correlation = 0;
              for (let i = 0; i < maxSamples; i++) {
                correlation += Math.abs(buffer[i] - buffer[i + offset]);
              }
              correlation = 1 - (correlation / maxSamples);
              
              if (correlation > 0.9 && correlation > lastCorrelation) {
                const foundGoodCorrelation = correlation > bestCorrelation;
                if (foundGoodCorrelation) {
                  bestCorrelation = correlation;
                  bestOffset = offset;
                }
              }
              lastCorrelation = correlation;
            }
            
            if (bestCorrelation > 0.01) {
              return sampleRate / bestOffset;
            }
            return -1;
          };

          const detectPitch = () => {
            if (!analyserRef.current) return;

            const bufferLength = analyserRef.current.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyserRef.current.getFloatTimeDomainData(buffer);

            const detectedFreq = autoCorrelate(buffer, audioContextRef.current.sampleRate);
            
            if (detectedFreq !== -1 && detectedFreq > 70 && detectedFreq < 400) {
              setFrequency(detectedFreq);
              const detectedNote = frequencyToNote(detectedFreq);
              setNote(detectedNote);
              
              const closest = findClosestString(detectedFreq);
              setClosestString(closest.string);
              const centsOff = getCents(detectedFreq, closest.frequency);
              setCents(centsOff);
            }

            rafIdRef.current = requestAnimationFrame(detectPitch);
          };

          const startListening = async () => {
            try {
              setError('');
              console.log('Requesting microphone access...');
              
              if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Microphone access not supported in this browser');
              }

              const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                  echoCancellation: false,
                  autoGainControl: false,
                  noiseSuppression: false
                } 
              });
              
              console.log('Microphone access granted');
              streamRef.current = stream;
              setPermissionStatus('granted');
              
              const AudioContext = window.AudioContext || window.webkitAudioContext;
              if (!AudioContext) {
                throw new Error('Web Audio API not supported');
              }
              
              audioContextRef.current = new AudioContext();
              analyserRef.current = audioContextRef.current.createAnalyser();
              microphoneRef.current = audioContextRef.current.createMediaStreamSource(stream);
              
              analyserRef.current.fftSize = 4096;
              microphoneRef.current.connect(analyserRef.current);
              
              console.log('Audio processing started');
              setIsListening(true);
              detectPitch();
            } catch (err) {
              console.error('Error accessing microphone:', err);
              setPermissionStatus('denied');
              
              if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                setError('Microphone access denied. Please allow microphone permission in your browser settings.');
              } else if (err.name === 'NotFoundError') {
                setError('No microphone found. Please connect a microphone and try again.');
              } else {
                setError(`Error: ${err.message}`);
              }
            }
          };

          const stopListening = () => {
            console.log('Stopping tuner...');
            
            if (rafIdRef.current) {
              cancelAnimationFrame(rafIdRef.current);
            }
            if (microphoneRef.current) {
              microphoneRef.current.disconnect();
            }
            if (audioContextRef.current) {
              audioContextRef.current.close();
            }
            if (streamRef.current) {
              streamRef.current.getTracks().forEach(track => track.stop());
            }
            
            setIsListening(false);
            setFrequency(0);
            setNote('');
            setCents(0);
            setClosestString('');
          };

          useEffect(() => {
            return () => {
              stopListening();
            };
          }, []);

          const getTuningColor = () => {
            if (Math.abs(cents) < 5) return 'text-green-600';
            if (Math.abs(cents) < 20) return 'text-amber-600';
            return 'text-red-700';
          };

          const getTuningMessage = () => {
            if (Math.abs(cents) < 5) return 'In Tune!';
            if (cents > 0) return 'Too Sharp';
            return 'Too Flat';
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-amber-100 via-orange-50 to-yellow-100 flex items-center justify-center p-4">
              <div className="relative max-w-md w-full">
                {/* Wood grain texture background */}
                <div className="absolute inset-0 bg-gradient-to-br from-amber-800 via-amber-700 to-amber-900 rounded-3xl transform rotate-1"></div>
                <div className="absolute inset-0 bg-gradient-to-tr from-amber-900 via-amber-800 to-amber-700 rounded-3xl transform -rotate-1"></div>
                
                <div className="relative bg-gradient-to-br from-amber-700 via-yellow-800 to-amber-900 rounded-3xl shadow-2xl p-8 border-4 border-amber-950" style={{
                  boxShadow: 'inset 0 2px 10px rgba(0,0,0,0.3), 0 10px 30px rgba(0,0,0,0.4)'
                }}>
                  {/* Decorative corner pieces */}
                  <div className="absolute top-4 left-4 w-8 h-8 border-t-4 border-l-4 border-yellow-600 opacity-40"></div>
                  <div className="absolute top-4 right-4 w-8 h-8 border-t-4 border-r-4 border-yellow-600 opacity-40"></div>
                  <div className="absolute bottom-4 left-4 w-8 h-8 border-b-4 border-l-4 border-yellow-600 opacity-40"></div>
                  <div className="absolute bottom-4 right-4 w-8 h-8 border-b-4 border-r-4 border-yellow-600 opacity-40"></div>

                  <div className="flex items-center justify-center mb-8">
                    <Music className="w-10 h-10 text-yellow-300 mr-3" />
                    <h1 className="text-4xl font-bold text-yellow-100" style={{
                      textShadow: '2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(251, 191, 36, 0.3)',
                      fontFamily: 'serif'
                    }}>Acoustic Tuner</h1>
                  </div>

                  {error && (
                    <div className="mb-6 bg-red-900 border-2 border-red-950 rounded-lg p-4 flex items-start shadow-inner">
                      <AlertCircle className="w-5 h-5 text-red-300 mr-3 flex-shrink-0 mt-0.5" />
                      <p className="text-red-100 text-sm">{error}</p>
                    </div>
                  )}

                  <div className="mb-8 text-center">
                    <button
                      onClick={isListening ? stopListening : startListening}
                      className={`${
                        isListening 
                          ? 'bg-gradient-to-b from-red-700 to-red-900 hover:from-red-600 hover:to-red-800 border-red-950' 
                          : 'bg-gradient-to-b from-amber-600 to-amber-800 hover:from-amber-500 hover:to-amber-700 border-amber-950'
                      } text-yellow-50 font-bold py-4 px-8 rounded-full transition-all transform hover:scale-105 flex items-center justify-center mx-auto shadow-lg border-4`}
                      style={{
                        textShadow: '1px 1px 2px rgba(0,0,0,0.5)',
                        fontFamily: 'serif'
                      }}
                    >
                      {isListening ? (
                        <>
                          <MicOff className="w-6 h-6 mr-2" />
                          Stop Listening
                        </>
                      ) : (
                        <>
                          <Mic className="w-6 h-6 mr-2" />
                          Start Tuning
                        </>
                      )}
                    </button>
                  </div>

                  {isListening && (
                    <div className="space-y-6">
                      <div className="bg-gradient-to-br from-yellow-50 to-amber-100 rounded-2xl p-6 text-center border-4 border-amber-900 shadow-inner">
                        <div className="text-7xl font-bold mb-2" style={{
                          color: '#78350f',
                          textShadow: '3px 3px 0px rgba(217, 119, 6, 0.3)',
                          fontFamily: 'serif'
                        }}>
                          {note || '-'}
                        </div>
                        <div className="text-amber-800 text-sm mb-4 font-semibold">
                          {frequency > 0 ? `${frequency.toFixed(1)} Hz` : 'Listening for strings...'}
                        </div>
                        {closestString && (
                          <div className="text-amber-900 text-xl font-bold" style={{fontFamily: 'serif'}}>
                            {closestString}
                          </div>
                        )}
                      </div>

                      {frequency > 0 && (
                        <div className="bg-gradient-to-br from-amber-200 to-yellow-200 rounded-2xl p-6 border-4 border-amber-900 shadow-inner">
                          <div className={`text-3xl font-bold text-center mb-4 ${getTuningColor()}`} style={{
                            textShadow: '1px 1px 2px rgba(255,255,255,0.5)',
                            fontFamily: 'serif'
                          }}>
                            {getTuningMessage()}
                          </div>
                          
                          <div className="relative h-4 bg-amber-900 rounded-full overflow-hidden border-2 border-amber-950 shadow-inner">
                            <div 
                              className="absolute top-0 h-full w-2 transition-all shadow-lg"
                              style={{ 
                                left: `${Math.max(0, Math.min(100, 50 + cents))}%`,
                                backgroundColor: Math.abs(cents) < 5 ? '#16a34a' : Math.abs(cents) < 20 ? '#d97706' : '#b91c1c',
                                transform: 'translateX(-50%)'
                              }}
                            />
                            <div className="absolute top-0 left-1/2 h-full w-1 bg-yellow-300 shadow-lg" style={{transform: 'translateX(-50%)'}} />
                          </div>
                          
                          <div className="flex justify-between text-xs text-amber-900 mt-2 font-bold">
                            <span>♭ Flat</span>
                            <span className="bg-amber-100 px-2 py-1 rounded">{cents > 0 ? '+' : ''}{cents} cents</span>
                            <span>Sharp ♯</span>
                          </div>
                        </div>
                      )}

                      <div className="bg-gradient-to-br from-yellow-100 to-amber-200 rounded-2xl p-5 border-4 border-amber-900 shadow-inner">
                        <h3 className="text-amber-950 font-bold mb-3 text-center text-lg" style={{fontFamily: 'serif'}}>
                          Standard Tuning
                        </h3>
                        <div className="space-y-2">
                          {guitarStrings.map((string, idx) => (
                            <div 
                              key={idx}
                              className={`flex justify-between text-sm p-3 rounded-lg border-2 transition-all ${
                                closestString === string.string 
                                  ? 'bg-gradient-to-r from-amber-600 to-amber-700 text-yellow-50 border-amber-900 shadow-lg transform scale-105' 
                                  : 'bg-amber-50 text-amber-900 border-amber-300'
                              }`}
                              style={{fontFamily: 'serif'}}
                            >
                              <span className="font-bold">{string.string}</span>
                              <span className="font-semibold">{string.name} · {string.frequency.toFixed(2)} Hz</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}

                  {!isListening && !error && (
                    <div className="text-center text-yellow-100 mt-8" style={{fontFamily: 'serif'}}>
                      <p className="text-lg mb-2">Strum a string and let's tune up!</p>
                      <p className="text-sm mt-2 opacity-80">Click the button above to get started</p>
                      <p className="text-xs mt-4 opacity-60">Best results in a quiet campfire setting</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuitarTuner />);
    </script>
</body>
</html>